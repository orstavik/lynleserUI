<dom-module id="navigation-drawer">
  <template>
    <style>
      #drawer {
        display: flex;
        width: 80%;
        max-width: 300px;
        height: 100vh;
        position: absolute;
        top: 0;
        background-color: white;
        transform: translateX(-110%);
        transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        will-change: transform;
        @apply(--shadow-elevation-16dp);
      }
      :host([opened]) #drawer {
        transform: translateX(0);
      }
      :host([moving]) #drawer {
        transition: none;
      }
      #shadow {
        display: block;
        width: 100vw;
        height: 100vh;
        position: absolute;
        top: 0;
        opacity: 1;
        background-color: rgba(0,0,0,0.4);
        transition: opacity 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      }
      :host(:not([opened])) #shadow {
        opacity: 0;
        pointer-events: none;
      }
    </style>

    <div id="shadow" on-tap="close"></div>
    <div id="drawer" style$="[[_style]]">
      <slot></slot>
    </div>

  </template>

  <script>
    class NavigationDrawer extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'navigation-drawer'; }
      static get properties() {
        return {
          opened: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          moving: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          _style: String
        }
      }

      constructor() {
        super();
        window.addEventListener("touchstart", this._touchStart.bind(this));
        window.addEventListener("touchmove", this._touchMove.bind(this));
      }

      open() {
        this.opened = true;
      }

      close() {
        this.opened = false;
      }

      _touchStart(e) {
        this.touchEnd = this._touchEnd.bind(this);
        window.addEventListener("touchend", this.touchEnd);
        console.log("start");
      }

      _touchMove(e) {
        let x = e.touches[0].clientX;
        this.x = this.x ? this.x : 0;
        let width = this.$.drawer.getBoundingClientRect().width;
        if ((this.x <= 40 && !this.opened) || this.opened) {
          if (x > width)
            x = width;
          this._moveDrawer(x);
          this.moving = true;
        }
      }

      _touchEnd(e) {
        if (this.moving) {
          let width = this.$.drawer.getBoundingClientRect().width;
          this._style = "";
          let x = e.changedTouches[0].clientX;
          if (x >= width/2)
            this.open();
          else
            this.close();
          this.moving = false;
        }
        window.removeEventListener("touchend", this.touchEnd);
        console.log("end");
      }

      _moveDrawer(x) {
        this._style = "transform: translateX(calc("+x+"px - 100%))";
      }
    }
    window.customElements.define(NavigationDrawer.is, NavigationDrawer);
  </script>
</dom-module>